# 🧾 F&F 원가대시보드

F&F 시즌별 원가 데이터를 분석하고 시각화하는 Next.js 기반 웹 애플리케이션입니다.

## 📌 주요 기능

- 📊 전체/카테고리별 원가율 분석
- 🔥 아이템별 원가 구성 히트맵
- 📈 시즌 간 비교 차트
- 🤖 AI 기반 인사이트 생성
- 💹 실시간 데이터 연동

## 🚀 시작하기

### 1. 의존성 설치

```bash
npm install
```

### 2. 환경 변수 설정 (선택사항)

AI 기능을 사용하려면 OpenAI API 키가 필요합니다.

`.env.local` 파일을 생성하고 다음 내용을 추가하세요:

```
OPENAI_API_KEY=sk-your-actual-api-key-here
```

### 3. Summary JSON 생성

CSV 파일에서 집계 데이터를 생성합니다:

```bash
python generate_summary.py
```

### 4. 개발 서버 실행

```bash
npm run dev
```

브라우저에서 [http://localhost:3000](http://localhost:3000)을 열어 확인하세요.

## 📁 프로젝트 구조

```
COST2/
├── app/                          # Next.js 앱 디렉토리
│   ├── page.tsx                 # 메인 페이지
│   ├── layout.tsx               # 레이아웃
│   ├── globals.css              # 전역 스타일
│   └── api/
│       └── generate-comment/
│           └── route.ts         # AI 코멘트 생성 API
├── components/                   # React 컴포넌트
│   ├── Dashboard.tsx            # 히트맵 테이블
│   ├── StoryCards.tsx           # 원가율 카드
│   ├── CategoryComparison.tsx   # 레이더 차트
│   ├── WaterfallChart.tsx       # 워터폴 차트
│   └── ExecutiveSummary.tsx     # 경영진 요약
├── lib/                         # 유틸리티 함수
│   ├── csvParser.ts             # CSV 파싱 로직
│   └── types.ts                 # TypeScript 타입
├── public/                       # 정적 파일
│   ├── MLB 251107.csv           # 원본 데이터
│   └── summary.json             # 집계 데이터
├── generate_summary.py           # Python 집계 스크립트
├── package.json
├── tsconfig.json
├── tailwind.config.ts
└── next.config.js
```

## 🔑 핵심 원칙

### 화폐 기준

- **USD 기준 (기본)**: 모든 계산은 USD 기준으로 진행
- **KRW 기준 (예외)**: 오직 "전체(KRW)" 카드만 예외적으로 KRW 사용

### 환율 적용 원칙 ⚠️ 중요!

```
당시즌 TAG USD 변환 = 전시즌 환율 적용
- 24F TAG USD: KRW TAG ÷ 1288 (24F 환율)
- 25F TAG USD: KRW TAG ÷ 1288 (전시즌 24F 환율 사용!)

※ CSV의 KRW 원가 컬럼:
  - 24F: USD × 1288 환율로 저장됨
  - 25F: USD × 1420 환율로 저장됨
```

### 원가 항목 정의

```
원부자재 = 원자재 + 부자재 + 본사공급자재 + 택/라벨
⚠️ 주의: 아트웍은 원부자재에 포함되지 않습니다!

총원가 = 원부자재 + 아트웍 + 공임 + 정상마진 + 경비
```

### 원가율 계산 공식

```javascript
원가율 = (평균원가 ÷ (평균TAG / 1.1)) × 100
```

### 카테고리 동적 필터링 🆕

**시스템이 CSV 파일에 실제로 존재하는 카테고리만 자동으로 표시합니다.**

#### 적용 위치
1. **카테고리 필터 드롭다운** (히트맵 테이블 상단)
2. **레이더 차트** (카테고리별 원가 구성 비교)
3. **카테고리 색상 범례** (페이지 하단) 🆕

```typescript
// 예시: MLB non 251111.csv 파일의 경우
실제 존재하는 카테고리 (자동 표시):
- Shoes (슈즈) - #8b5cf6 (보라색)
- Bag (가방) - #ec4899 (핑크색)
- Acc_etc (악세사리) - #ef4444 (빨간색)

표시되지 않는 카테고리 (데이터 없음):
- Outer (아우터) - #3b82f6 (파란색)
- Inner (이너) - #10b981 (초록색)
- Bottom (바텀) - #f59e0b (주황색)
```

**구현 방법:**
```typescript
// items 배열에서 실제 존재하는 카테고리 추출
const categorySet = new Set(items.map(item => item.category));
const availableCategories = CATEGORIES.filter(cat => categorySet.has(cat.id));
```

### 카테고리 표시 순서 (전체 목록)

1. **의류 (Apparel)**
   - Outer (아우터) - 파란색 `#3b82f6`
   - Inner (이너) - 초록색 `#10b981`
   - Bottom (바텀) - 주황색 `#f59e0b`

2. **시즌 악세사리 (Seasonal Accessories)**
   - Shoes (슈즈) - 보라색 `#8b5cf6`
   - Bag (가방) - 핑크색 `#ec4899`
   - Headwear (헤드웨어) - 하늘색 `#06b6d4` 🆕
   - Acc_etc (악세사리) - 빨간색 `#ef4444`

### 카테고리 카드 표시 규칙 🆕

**원가율 카드 및 평균단가 카드는 발주 비중이 큰 상위 4개 카테고리만 표시합니다.**

```typescript
// 그리드 레이아웃: 5열 (XL 화면 이상)
grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5

// 표시 기준: 전체 + 상위 4개 카테고리 = 총 5개 카드
// 예시: 전체, Headwear, Bag, Shoes, Acc_etc

표시되는 카드 (한 줄에 5개):
┌─────┬─────────┬─────┬───────┬─────────┐
│전체 │Headwear │ Bag │ Shoes │ Acc_etc │
└─────┴─────────┴─────┴───────┴─────────┘

✅ 전체 원가율/평균단가 (항상 표시)
✅ 상위 4개 카테고리 카드 (발주 비중 순)
✅ XL 화면(1280px+)에서 한 줄 표시로 비교 용이

표시되지 않는 카테고리:
❌ Outer, Inner, Bottom (데이터 없음)
❌ 5위 이하 카테고리 (발주 비중 낮음)
```

**반응형 브레이크포인트:**

**원가율/평균단가 카드:**
- Mobile (< 640px): 1열 (세로 나열)
- Small (640px+): 2열
- Large (1024px+): 3열
- **XL (1280px+): 5열** ⭐ 모든 카드 한 줄 표시

**레이더 차트 (카테고리별 원가 구성 비교):**
- Mobile (< 768px): 1열 (세로 나열)
- Medium (768px+): 2열
- **XL (1280px+): 5열** ⭐ 모든 차트 한 줄 표시

**히트맵 중분류 필터:**
- 모든 실제 존재하는 카테고리가 드롭다운에 표시됨
- 사용자가 필터를 통해 선택 가능

## 📊 데이터 흐름

```
CSV 파일 (MLB non 251111.csv) + FX 파일 (FX 251111.csv)
    ↓
parseCsv() - CSV 파싱
    ↓
aggregateByItem() - 아이템별 집계
    ├→ 수량 필터링 (qty24F > 0 AND qty25F > 0) 🆕
    ├→ 히트맵 테이블
    └→ 상세 내역

summary.json (generate_summary.py)
    ↓
calculateTotalStats() - 전체 통계
calculateCategoryStats() - 카테고리 통계
    ├→ StoryCards (원가율 카드)
    ├→ CategoryComparison (레이더 차트)
    └→ WaterfallChart (워터폴 차트)
```

### 히트맵 아이템 필터링 규칙 🆕

**전년 또는 당년 수량이 0인 아이템은 자동으로 제외됩니다.**

```typescript
// 표시되는 아이템
✅ 전년 수량 > 0 AND 당년 수량 > 0

// 제외되는 아이템
❌ 전년 수량 = 0 (당년에만 존재)
❌ 당년 수량 = 0 (전년에만 존재)
❌ 둘 다 0 (데이터 없음)
```

**목적**: 의미있는 YOY 비교만 표시하여 데이터 품질 향상

### 히트맵 표시 형식 🆕

**평균TAG 및 원가 항목 변동 표시 규칙**

```typescript
// 평균 KRW TAG
- ₩ 기호 제거: 숫자만 표시 (예: 45,000)
- 전년 환율 적용: item.avgTag × 1297

// 히트맵 테이블 - 원가 항목별 변동
- 증가: +$0.00 형식 (빨간색 배경)
- 감소: -$0.00 형식 (파란색 배경)
- 적용 항목: 원부자재, 아트웍, 공임, 마진, 기타경비

// 상세 내역 (접기/펼치기) - 원가 항목별 변동
- 증가: +$0.00 형식 (빨간색 텍스트)
- 감소: -$0.00 형식 (초록색 텍스트)
- 적용 항목: 원부자재, 아트웍, 공임, 마진, 경비, 평균 원가

// 코드 예시
{materialChange >= 0 ? '+' : '-'}${Math.abs(materialChange).toFixed(2)}
// 결과: +$1.23 또는 -$1.23 (부호가 $ 앞에 위치)
```

**수정 내역**:
- ❌ Before: `+$-0.36` (잘못된 형식)
- ✅ After: `-$0.36` (올바른 형식)
- 총 11개 위치 수정 (테이블 5개 + 상세 내역 6개)

**목적**: 직관적인 금액 변동 표시로 실무 의사결정 지원

### 카테고리별 원가 구성 비교 - 차이 컬럼 🆕

**"카테고리별 원가 구성 비교 (USD 기준)" 하단 테이블에 "차이" 컬럼 추가**

```typescript
// 테이블 구조
┌─────────┬────────┬────────┬──────────┐
│  구분   │  전년  │  당년  │   차이   │
├─────────┼────────┼────────┼──────────┤
│ 원가율  │ 24.5%  │ 22.8%  │ -1.7%p ⬇ │ (초록색)
│ 원부자재│ 15.2%  │ 14.8%  │ -0.4%p ⬇ │ (초록색)
│ 아트웍  │  2.1%  │  2.3%  │ +0.2%p ⬆ │ (빨간색)
│ 공임    │  4.5%  │  4.2%  │ -0.3%p ⬇ │ (초록색)
│ 마진    │  1.8%  │  1.9%  │ +0.1%p ⬆ │ (빨간색)
│ 경비    │  0.9%  │  0.8%  │ -0.1%p ⬇ │ (초록색)
└─────────┴────────┴────────┴──────────┘
```

**코드 예시:**
```typescript
// 차이 계산 및 표시
<div className={`font-bold text-center py-1.5 text-[11px] ${
  (stats.costRate25F - stats.costRate24F) < 0 
    ? 'text-green-600'  // 감소 = 긍정
    : 'text-red-600'    // 증가 = 부정
}`}>
  {(stats.costRate25F - stats.costRate24F) > 0 ? '+' : ''}
  {(stats.costRate25F - stats.costRate24F).toFixed(1)}%p
</div>
```

**표시 규칙:**
- 증가: `+x.x%p` 형식, 빨간색 (text-red-600)
- 감소: `-x.x%p` 형식, 초록색 (text-green-600)
- 소수점 첫째자리까지 표시 (.toFixed(1))
- 모든 카테고리별로 동일하게 적용

**목적**: 전년 대비 변동폭 즉시 파악으로 카테고리별 원가 트렌드 분석 강화

### 평균단가 카드 - "전년 대비" 레이블 🆕

**평균단가 (USD 기준) 카드에 "전년 대비" 텍스트 추가**

```typescript
// Before
┌───────────────────────────┐
│ 전체 평균단가             │
│ $10.58                    │
│            ↑ +$1.24       │ (레이블 없음)
└───────────────────────────┘

// After
┌───────────────────────────┐
│ 전체 평균단가             │
│ $10.58                    │
│ 전년 대비      ↑ +$1.24  │ ✅ 레이블 추가
└───────────────────────────┘
```

**코드 예시:**
```typescript
// 전체 평균단가 카드 (Teal 배경)
<div className="flex items-center justify-between mb-2.5">
  <span className="text-[10px] opacity-80">전년 대비</span>
  <div className="flex items-center gap-1">
    <ArrowUp className="w-3 h-3 text-red-300" />
    <span className="text-[10px] font-bold text-red-300">
      +$1.24
    </span>
  </div>
</div>

// 카테고리별 평균단가 카드 (흰색 배경)
<div className="flex items-center justify-between mb-2.5">
  <span className="text-[10px] text-gray-500">전년 대비</span>
  <div className="flex items-center gap-1">
    <ArrowDown className="w-3 h-3 text-green-600" />
    <span className="text-[10px] font-bold text-green-600">
      -$0.45
    </span>
  </div>
</div>
```

**적용 카드:**
1. **전체 평균단가** (Teal 그라데이션)
   - 레이블 색상: `opacity-80` (흰색 반투명)
2. **카테고리별 평균단가** (Shoes, Bag, Acc_etc 등)
   - 레이블 색상: `text-gray-500`

**레이아웃 구조:**
- `flex justify-between`: 좌측(레이블) - 우측(화살표+금액) 배치
- 원가율 카드와 동일한 UI 패턴으로 일관성 확보
- 글씨 크기: `text-[10px]` (10px) 통일

**목적**: 변동량의 의미를 명확히 전달하여 대시보드 가독성 및 전문성 향상

## 🎯 콜아웃 정렬 개선

USD/KRW 비교 분석 섹션의 콜아웃 정렬을 개선하여 시각적 일관성을 확보했습니다.

### 변경 사항

**아이콘 정렬:**
- 아이콘 너비 고정: `w-5 flex-shrink-0` (20px 고정 너비)
- 간격 통일: `gap-3` (12px 간격)
- 좌측 정렬 일관성 확보

**텍스트 정렬:**
- 설명 텍스트에 `ml-8` 적용 (아이콘 너비 + gap 보정)
- 모든 콜아웃의 텍스트가 동일한 좌측 라인에서 시작
- 프로그레스 바도 동일한 들여쓰기 적용

**적용 위치:**
```typescript
// USD 개선 항목
<div className="flex items-start gap-3 mb-1">
  <span className="text-base w-5 flex-shrink-0">{item.icon}</span>
  <div className="flex-1">...</div>
</div>
<div className="ml-8">
  <EditableText ... />  // 설명 텍스트
  <div className="h-0.5 bg-green-400 ..."></div>  // 프로그레스 바
</div>

// KRW 리스크 항목
<div className="flex items-start gap-3 mb-1">
  <span className="text-base w-5 flex-shrink-0">{item.icon}</span>
  <div className="flex-1">...</div>
</div>
<div className="ml-8">
  <EditableText ... />  // 설명 텍스트
  <div className="h-0.5 bg-orange-400 ..."></div>  // 프로그레스 바
</div>

// 핵심 메시지
<div className="flex items-start gap-3">
  <span className="text-base w-5 flex-shrink-0">💡/⚠️</span>
  <div className="flex-1">...</div>
</div>
```

**시각적 효과:**
```
Before:
🎨 원부자재 효율화 ▼0.2%p
원부자재 단가 8.9% → 8.7%, 대량생산...
━━━━━━━━━━━━━━━━━━━━━━━━

💼 마진율 최적화 ▼0.2%p
   벤더 마진 1.5% → 1.3%, 생산량...
   ━━━━━━━━━━━━━━━━━━━━━━━━

After:
🎨 원부자재 효율화 ▼0.2%p
   원부자재 단가 8.9% → 8.7%, 대량생산...
   ━━━━━━━━━━━━━━━━━━━━━━━━

💼 마진율 최적화 ▼0.2%p
   벤더 마진 1.5% → 1.3%, 생산량...
   ━━━━━━━━━━━━━━━━━━━━━━━━
```

**개선 효과:**
- ✅ 모든 콜아웃의 텍스트가 동일한 수직선에서 시작
- ✅ 아이콘 크기 차이로 인한 정렬 불일치 해소
- ✅ 프로페셔널한 시각적 일관성 확보
- ✅ 가독성 향상

## 🤖 AI 기능

AI 인사이트 생성을 사용하려면:

1. OpenAI API 키 발급: https://platform.openai.com/api-keys
2. `.env.local` 파일에 `OPENAI_API_KEY` 추가
3. 개발 서버 재시작

### 사용 가능 기능

- USD/KRW 카드 AI 생성
- 워터폴 차트 AI 인사이트
- 카테고리 비교 AI 인사이트
- 경영진 종합 요약

## 🔧 문제 해결

### 히트맵 데이터가 잘못 표시되는 경우

```bash
# 1. 캐시 삭제
Remove-Item -Recurse -Force .next
Remove-Item -Recurse -Force node_modules\.cache

# 2. Node 프로세스 종료
taskkill /F /IM node.exe

# 3. 개발 서버 재시작
npm run dev

# 4. 브라우저 하드 리프레시
Ctrl + Shift + R (Windows)
```

### summary.json 재생성

CSV 파일이 업데이트될 때마다 실행:

```bash
python generate_summary.py
```

## 📝 버전 히스토리

### v1.4.0 (2025-11-11)
- **데이터 파일 업데이트**: MLB non 251111.csv + FX 251111.csv 적용
- **시즌명 변경**: 24F/25F → 전년/당년
- **동적 환율 적용**: FX 파일에서 자동으로 환율 로드
- **카테고리 동적 필터링**: CSV에 실제 존재하는 카테고리만 자동 표시
  - 카테고리 필터 드롭다운
  - 레이더 차트
  - 카테고리 색상 범례
- **히트맵 필터링**: 전년 또는 당년 수량이 0인 아이템 자동 제외
- **레이아웃 통일** 🆕:
  - 모든 주요 컴포넌트의 너비를 통일하여 일관된 UI 제공
  - 워터폴 차트: 전체 너비 사용
  - 주요지표 & 원가율 요약: 2열 그리드로 나란히 배치
  - 카테고리 비교: 전체 너비 사용
  - 히트맵: 전체 너비 사용
  - 목적: 시각적 일관성 및 가독성 향상
- **워터폴 차트 개선**:
  - 변화율 표시: 소수점 첫째자리로 통일 (0.1%p)
  - 표시 형식: 감소 `-x.x%p`, 증가 `+x.x%p` 통일 (차트 박스 및 하단 테이블 모두)
  - 색상 규칙: 감소(비용절감) = 🟢 초록색, 증가(비용상승) = 🔴 빨간색
  - 동적 색상 적용: 모든 변동 항목에 값에 따른 색상 자동 변경
  - 라벨 명확화: "원부자재변동(아트웍포함)"
  - 박스 내부 텍스트 제거로 깔끔한 UI
  - 액션/리스크/성공 포인트 멘트 데이터 기반으로 업데이트
  - **그래프 높이 비례 스케일 적용** 🆕:
    - 통일된 비율: 1%p = 50px
    - 최소 높이: 40px
    - 모든 막대가 실제 수치에 정확히 비례하여 표시
    - 시각적 정확성 및 비교 용이성 향상
- **원가율 카드 대시보드 개선**:
  - **그리드 레이아웃: 5열 그리드로 변경** 🆕:
    - 원가율 카드: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5`
    - 레이더 차트: `grid-cols-1 md:grid-cols-2 xl:grid-cols-5`
    - XL 화면(1280px 이상)에서 5개 카드(전체 + 4개 카테고리)가 한 줄에 표시
    - 적용 섹션: 원가율(USD), 평균단가(USD), 원가율(KRW), 카테고리별 원가 구성 비교
    - 목적: 모든 카테고리를 한눈에 비교 가능하도록 공간 효율 극대화
  - 원가율 카드: 호버 효과, 글씨 크기 최적화 (36px → 30px)
  - 평균단가 카드: 전년대비 변화량 표시 추가 (화살표 + 금액), 글씨 크기 조정 (30px → 24px)
  - **평균단가 "전년 대비" 레이블 추가** 🆕:
    - 전체 평균단가 카드: "전년 대비" 텍스트 좌측 배치 (opacity-80)
    - 카테고리별 평균단가 카드: "전년 대비" 텍스트 좌측 배치 (text-gray-500)
    - 원가율 카드와 동일한 레이아웃으로 UI 일관성 확보
    - `flex justify-between` 구조로 좌측(레이블) - 우측(화살표+금액) 배치
  - 레이더 차트: 높이 최적화 (350px → 300px), 글씨 크기 조정 (13px → 11px)
  - 전체적인 글씨 크기 축소로 정보 밀도 향상 및 가독성 개선
  - 패딩 최적화 (p-7 → p-6, p-5 → p-4)
  - 통일된 디자인 시스템 (그라데이션, 둥근 테두리, 그림자)
- **카테고리별 원가 구성 비교 테이블 개선** 🆕:
  - **"차이" 컬럼 추가**: 각 카테고리의 전년 대비 원가율 차이 표시
  - 표시 형식: `+x.x%p` (증가, 빨간색) / `-x.x%p` (감소, 초록색)
  - 적용 항목: 원가율, 원부자재, 아트웍, 공임, 마진, 경비
  - 그리드 레이아웃: 3열(구분-전년-당년) → 4열(구분-전년-당년-차이)
  - 동적 색상 적용: 값에 따른 red/green 자동 변경
  - 계산 로직: `당년 - 전년` (소수점 첫째자리)
- **멘트 전체 업데이트**:
  - 주요 지표 테이블: 핵심 성과 요약 데이터 기반 분석
  - USD/KRW 비교 분석: 실제 수치 반영한 상세 인사이트
  - YOY 열 한 줄 표시, ✅ 체크 표시 제거
- **Headwear 카테고리 추가** 🆕:
  - 전체 카테고리 목록에 Headwear (헤드웨어) 추가
  - 색상: 하늘색 `#06b6d4` (Cyan)
  - 표시 순서: Bag 다음, Acc_etc 이전 (order: 6)
  - 적용 위치: 원가율 카드, 평균단가 카드, 레이더 차트, 히트맵 필터
  - 원가율: 15.3% → 14.3% (-1.0%p 개선)
- **카테고리 카드 표시 규칙 명확화** 🆕:
  - 원가율/평균단가 카드: 발주 비중 상위 4개 카테고리만 표시 (전체 포함 총 5개 카드)
  - 레이더 차트: 발주 비중 상위 4개 카테고리만 표시 (전체 포함 총 5개)
  - 5열 그리드 레이아웃으로 모든 차트/카드가 한 줄에 표시: 전체 + Headwear + Bag + Shoes + Acc_etc
  - 히트맵 필터: 모든 실제 존재 카테고리 표시 (사용자 선택 가능)
- **대시보드 제목 업데이트**:
  - "F&F 원가 대시보드" → "F&F 원가 대시보드 (MLB NON시즌 원가)"
  - 헤더 및 푸터 양쪽 모두 적용
- **USD/KRW 비교 분석 콜아웃 정렬 개선** 🆕:
  - 아이콘 너비 고정: `w-5 flex-shrink-0` (20px)
  - 간격 통일: `gap-3` (12px)
  - 설명 텍스트 들여쓰기: `ml-8` 적용
  - 프로그레스 바 정렬: 텍스트와 동일한 들여쓰기
  - 모든 콜아웃의 텍스트가 동일한 수직선에서 시작
  - 시각적 일관성 및 가독성 향상
- **KRW 기준 분석 항목 추가** 🆕:
  - "제품 믹스 효과로 원부자재 평균단가 상승" 항목 추가
  - 고단가군(신발·가방) vs 저단가군(헤드웨어·양말) 비중 변화 분석
  - 카테고리별 단가 하락에도 전체 평균단가 상승 원인 설명
  - 제품 포트폴리오 믹스 변화가 원가에 미치는 영향 가시화

### v1.3.0 (2025-01-07)
- **환율 적용 로직 변경**: 25F TAG USD 변환 시 24F 환율(1288) 적용
- 워터폴 차트 UI 박스 형태로 변경
- 환율효과(FX) 및 실질원가효과(Real) 설명 카드 추가

### v1.2.0 (2025-01-07)
- 원부자재 정의 수정 (아트웍 제외, 본사공급자재 포함)
- CSV 파싱 인덱스 수정
- 히트맵 데이터 연결 완료
- 카테고리 순서 통일

## 📞 문의

**담당**: F&F 경영관리팀 FP&A / Cost Analysis

## 📄 라이선스

© F&F 경영관리팀 FP&A / Cost Analysis Dashboard Framework

